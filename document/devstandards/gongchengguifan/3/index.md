# 3. Changelog ç¼–å†™è§„èŒƒ

## å‰è¨€

https://www.conventionalcommits.org/zh-hans/v1.0.0/#%e7%ba%a6%e5%ae%9a%e5%bc%8f%e6%8f%90%e4%ba%a4%e8%a7%84%e8%8c%83

> ä½œä¸ºä¸€ä¸ªæ™®é€šçš„å¼€å‘è€…ï¼Œæˆ‘å¿…é¡»ä¸ºæˆ‘çš„é¡¹ç›®ç»´æŠ¤ä¸€ä¸ªæ›´æ–°æ—¥å¿—ï¼ˆä»¥ä¸‹ç®€ç§° changelogï¼‰å—ï¼Ÿ

1. å¦‚æœä½ åœ¨ç»´æŠ¤ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œæˆ–è€…å…¬å¸å†…éƒ¨çš„åº•å±‚æŠ€æœ¯äº§å“ï¼Œé‚£ä¹ˆæä¾›ä¸€ä¸ª changelog æ˜¯å¿…éœ€çš„ã€‚å¼€å‘è€…ç”¨æˆ·å¾ˆå¯èƒ½éœ€è¦ä»ä¸€ä¸ªä½ç‰ˆæœ¬å‡çº§åˆ°æœ€æ–°ç‰ˆï¼Œchangelog å¯ä»¥å¸®åŠ©ä»–ä»¬äº†è§£æ–°ç‰ˆæœ¬æœ‰å“ªäº›å˜åŒ–ã€‚
2. å¦‚æœä½ åœ¨å¼€å‘ä¸€ä¸ªä¸šåŠ¡åº”ç”¨ï¼Œé‚£ä¹ˆ changelog ä¸æ˜¯å¿…éœ€çš„ã€‚ç„¶è€Œæä¾›ä¸€ä¸ª changelog ä¼šæ›´å¥½ï¼Œå› ä¸ºå…¶ä»–åä½œè€…æˆ–æ˜¯äº¤æ¥æ–¹èƒ½æ›´ç›´è§‚åœ°çœ‹åˆ°ä¸šåŠ¡é€»è¾‘çš„æ¼”å˜ã€‚

æˆ‘è®°å¾—ä½ è¿˜çº¦æŸäº† Git log çš„è§„èŒƒï¼Œé‚£ä¸ºä½•è¿˜è¦å†è§„èŒƒ changelog çš„æ ¼å¼å‘¢ï¼Ÿä¸¤è€…ä¸æ˜¯å·®ä¸å¤šï¼Ÿ

1. å³ä¾¿æ˜¯çº¦æŸäº† Git log çš„è§„èŒƒï¼Œä¹Ÿæ— æ³•ç›´æ¥å°† Git log å¯¼å‡ºä¸€ä¸ªè‰¯å¥½çš„ changelogã€‚å› ä¸º changelog ä¸­æè¿°çš„å†…å®¹éœ€è¦æ›´åŠ ç²¾ç‚¼å’Œå½’çº³ï¼Œå¯¹ä¿¡æ¯é™å™ªå¤„ç†ç­‰ç­‰ï¼Œå› æ­¤æ‰‹å†™ changelog ä»ç„¶æ˜¯æ›´å¥½çš„é€‰æ‹©ï¼›å½“ç„¶ï¼Œä¸æ’é™¤ä»¥åè‡ªåŠ¨è½¬æ¢çš„å¯èƒ½ã€‚
2. ä¸ç®¡æ˜¯æ‰‹å†™è¿˜æ˜¯è‡ªåŠ¨è½¬æ¢ï¼Œchangelog çš„æ ¼å¼éƒ½ä¸èƒ½ç›´æ¥ç…§æ¬ Git log çš„æ ¼å¼ã€‚è¿™ä¸¤è€…çš„åŒºåˆ«ä¸è”ç³»åŒåœ¨ã€‚

## changelog æ–‡ä»¶
ç»„ä»¶ä¸‹çš„ changelog æ–‡ä»¶å¿…é¡»å–åä¸º HISTORY.mdï¼Œå­˜æ”¾åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹ï¼Œå’Œ README.mdã€CONTRIBUTING.md ç­‰å¹¶åˆ—ï¼ŒåŒæ—¶ä¿æŒé£æ ¼ä¸€è‡´ã€‚

## åŸºæœ¬çš„ changelog æ ¼å¼

```
# {Group} - {ComponentName}
## [<version>]
* <desc>
* <desc>
```

å…¶ä¸­ï¼ŒæŒ‰ç…§æœ€æ–°çš„ç‰ˆæœ¬å·åœ¨å‰çš„é¡ºåºæ’åˆ—ã€‚

## è¯æ±‡è¡¨


### æ ‡é¢˜

æ ‡é¢˜éƒ¨åˆ†ä½¿ç”¨å›ºå®šçš„æ–‡æ¡ˆï¼šã€Œæ›´æ–°æ—¥å¿—ã€ã€‚

å¦‚æœæ˜¯é¢å‘å›½é™…çš„é¡¹ç›®ï¼Œéœ€è¦ä½¿ç”¨è‹±æ–‡ï¼Œåˆ™æ–‡æ¡ˆä¸ºã€ŒChange Logã€ã€‚

### version

ç‰ˆæœ¬å· version å³é¡¹ç›®çš„æ¯ä¸€ä¸ªå‘å¸ƒç‰ˆæ‰€ä½¿ç”¨çš„ç‰ˆæœ¬å·ã€‚ç‰ˆæœ¬å·éœ€éµå¾ª SemVer ç‰ˆæœ¬å·å‘½åè§„èŒƒã€‚

æ³¨æ„ï¼šç‰ˆæœ¬å·å‰ä¸è¦åŠ  vã€‚

å¦å¤–ï¼Œç‰ˆæœ¬å·å»ºè®®å¢åŠ ä¸€ä¸ªé“¾æ¥ï¼ŒæŒ‡å‘å½“å‰ç‰ˆæœ¬å’Œä¸Šä¸€ä¸ªç‰ˆæœ¬ä¹‹é—´çš„ diffã€‚è¯¦æƒ…å¯å‚è€ƒåæ–‡çš„æ ·æœ¬ç¤ºä¾‹ã€‚

```
### type
æ›´æ–°ç±»å‹ type ç”¨ä»¥è¯´æ˜æ›´æ–°çš„æ–¹é¢ã€‚è¿™é‡Œçš„ type å’Œ Git æäº¤æ—¥å¿—ä¸­çš„ type æœ‰æ‰€è”ç³»ï¼Œç„¶è€Œå¹¶ä¸ä¸€ä¸€å¯¹åº”ã€‚
åŒå‰é¢æåˆ°çš„ã€Œæ ‡é¢˜ã€éƒ¨åˆ†ï¼Œé»˜è®¤ä½¿ç”¨ä¸­æ–‡ç‰ˆæœ¬çš„è¯æ±‡ï¼Œå¦‚æœæ˜¯é¢å‘å›½é™…çš„é¡¹ç›®ï¼Œåˆ™ä½¿ç”¨æ‹¬å·ä¸­çš„è‹±æ–‡ç‰ˆæœ¬ã€‚
type çš„å¯é€‰å€¼å¦‚ä¸‹ï¼š
* æ–°å¢ï¼ˆFeaturesï¼‰ï¼šæ–°å¢åŠŸèƒ½ã€‚
* ä¿®å¤ï¼ˆFixedï¼‰ï¼šä¿®å¤ bugã€‚
* å˜æ›´ï¼ˆChangedï¼‰ï¼šå¯¹äºæŸäº›å·²å­˜åœ¨åŠŸèƒ½æ‰€å‘ç”Ÿçš„é€»è¾‘å˜åŒ–ã€‚
* ä¼˜åŒ–ï¼ˆRefactoredï¼‰ï¼šæ€§èƒ½æˆ–ç»“æ„ä¸Šçš„ä¼˜åŒ–ï¼Œå¹¶æœªå¸¦æ¥åŠŸèƒ½çš„é€»è¾‘å˜åŒ–ã€‚
* å³å°†åˆ é™¤ï¼ˆDeprecatedï¼‰ï¼šä¸å»ºè®®ä½¿ç”¨ / åœ¨ä»¥åçš„ç‰ˆæœ¬ä¸­å³å°†åˆ é™¤çš„åŠŸèƒ½ã€‚
* åˆ é™¤ï¼ˆRemovedï¼‰ï¼šå·²åˆ é™¤çš„åŠŸèƒ½ã€‚
### desc
æè¿°å†…å®¹ desc éœ€è¦æ³¨æ„ï¼š
1. ä½¿ç”¨å®Œæ•´çš„å¥å­ã€‚å³åœ¨æ ‡ç‚¹æ–¹é¢éµå¾ªä¸€èˆ¬çš„æ–‡æ¡£æ ¼å¼è§„èŒƒï¼›å¦‚æœä½¿ç”¨è‹±è¯­ï¼Œåˆ™å¥é¦–å¤§å†™ã€‚
2. æ—¶æ€æ–¹é¢ä½¿ç”¨ä¸€èˆ¬ç°åœ¨æ—¶ï¼Œä¸è¦ç”¨è¿‡å»æ—¶æ€ã€‚è™½ç„¶æŸ¥çœ‹ changelog æ—¶ï¼Œchangelog å†…å®¹æœ¬èº«éƒ½å‘ç”Ÿåœ¨è¿‡å»ï¼Œç„¶è€Œä½¿ç”¨ç°åœ¨æ—¶çš„æ—¶æ€æ›´ç®€æ´æ˜ç¡®ï¼Œå¹¶ä¸”æ›´æ˜“è¾¾æˆä¸€è‡´æ€§ã€‚
3. å¥å¼ä½¿ç”¨ç¥ˆä½¿å¥å¼ã€‚å³ä¸€èˆ¬æƒ…å†µä¸è¦å¢åŠ ä¸»è¯­ã€‚å› ä¸ºåœ¨ç»å¤§æƒ…å†µä¸‹ï¼Œä¸»è¯­éƒ½æ˜¯ä½œè€…ã€Œæˆ‘ã€ã€‚
4. æ³¨æ˜ä¿®å¤çš„é—®é¢˜ã€‚å¦‚æœ‰æè¿‡ issueï¼Œåˆ™åœ¨å¥å°¾å¢åŠ  issue çš„ ID å’Œé“¾æ¥ã€‚
## æ ·æœ¬ç¤ºä¾‹

# Next - Search
---
## 0.2.5
`tag:z` ä¸å†æ§åˆ¶på…ƒç´ ï¼Œå¢åŠ class `next-form-text-align` æ¥æ§åˆ¶å¯¹é½
## 0.2.4
`tag:z` labelå±•ç°ä¼˜åŒ–
## 0.2.3
`tag:z` å¢åŠ å†…åµŒæ¨¡å¼
## 0.2.2
`tag:z` Form.Itemå¢åŠ sizeå±æ€§
```

å‚è€ƒèµ„æ–™

1. Keep a CHANGELOG
http://keepachangelog.com/

2. The Discussion about Change Log
https://news.ycombinator.com/item?id=9054627

### è‡ªåŠ¨ç”ŸæˆCHANGELOG.md

```
const execa = require('execa');
const groupBy = require('lodash/groupBy');
const sortBy = require('lodash/sortBy');
const uniq = require('lodash/uniq');
const {writeFile, readFileSync} = require('fs-extra');
const args = require('minimist')(process.argv.slice(2));

const types = {
  fix: {title: 'ğŸ› Bug Fixes'},
  feat: {title: 'ğŸš€ Features'},
  refactor: {title: 'ğŸ’… Refactors'},
  refact: {title: 'ğŸ’… Refactors'},
  perf: {title: 'ğŸ”¥ Performance'},
  examples: {title: 'ğŸ“ Examples'},
  chore: {title: 'ğŸ¡ Chore'},
  test: {title: 'ğŸ‘“ Tests'},
};

const knownAuthors = [];
const ignoreScopes = ['deps'];

const isKnownAuthor = name =>{
  console.log('name:=>',name);
  return Boolean(knownAuthors.find(n => name.toLowerCase().includes(n)))
};

const allowedTypes = Object.keys(types);

async function main() {
  // Get last git tag
  const lastGitTag = await getLastGitTag();

  // Get current branch
  const currentGitBranch = await getCurrentGitBranch();

  // Get all commits from last release to current branch
  console.log(`${currentGitBranch}...${lastGitTag}`);
  let commits = await getGitDiff(currentGitBranch, lastGitTag);

  // Parse commits as conventional commits
  commits = parseCommits(commits);

  // Filter commits
  commits = commits.filter(c => allowedTypes.includes(c.type));

  // Generate markdown
  const markdown = generateMarkDown(commits);

  // Show in console
  process.stdout.write('\n\n' + markdown + '\n\n');

  // Write to CHANGELOG.md
  const targetVersion = args._[0];

  if (targetVersion) {
    const title = `v${targetVersion} / ${getDate()}` + '\n===================';
    let oldMarkdown = readFileSync('CHANGELOG.md', {encoding: 'utf8'});
    await writeFile('CHANGELOG.md', title + '\n\n' + markdown + '\n\n' + oldMarkdown, 'utf-8');
  }
}

function getDate(split = '-') {
  const t = new Date();
  const twoDig = num => ('0' + num).slice(-2);
  const r = [t.getFullYear(), twoDig(t.getMonth() + 1), twoDig(t.getDate())];
  return r.join(split);
}

function execCommand(cmd, args) {
  return execa(cmd, args).then(r => r.stdout);
}

async function getLastGitTag() {
  const r = await execCommand('git', ['--no-pager', 'tag', '--sort=v:refname', '-l']).then(r => r.split('\n'));
  return r[r.length - 1];
}

async function getCurrentGitBranch() {
  const r = await execCommand('git', ['rev-parse', '--abbrev-ref', 'HEAD']);
  return r;
}

async function getGitDiff(from, to) {
  // # https://git-scm.com/docs/pretty-formats
  const r = await execCommand('git', ['--no-pager', 'log', `${from}...${to}`, '--pretty=%s|%h|%an|%ae']);
  return r.split('\n').map(line => {
    const [message, commit, authorName, authorEmail] = line.split('|');

    return {message, commit, authorName, authorEmail};
  });
}

function parseCommits(commits) {
  return commits
    .filter(c => c.message.includes(':'))
    .map(commit => {
      let [type, ...message] = commit.message.split(':');
      message = message.join(':');

      // Extract references from message
      message = message.replace(/\((fixes) #\d+\)/g, '');
      const references = [];
      const referencesRegex = /#[0-9]+/g;
      let m;
      while ((m = referencesRegex.exec(message))) {
        // eslint-disable-line no-cond-assign
        references.push(m[0]);
      }

      // Remove references and normalize
      message = message.replace(referencesRegex, '').replace(/\(\)/g, '').trim();

      // Extract scope from type
      let scope = type.match(/\((.*)\)/);
      scope = !scope ? 'general' : scope[1];
      type = type.split('(')[0];

      return {
        ...commit,
        message,
        type,
        scope,
        references,
      };
    });
}

function generateMarkDown(commits) {
  console.log(commits,'authorsauthorsauthors');
  const typeGroups = groupBy(commits, 'type');

  let markdown = '';

  for (const type of allowedTypes) {
    const group = typeGroups[type];
    if (!group || !group.length) {
      continue;
    }

    const {title} = types[type];
    markdown += '\n\n' + '### ' + title + '\n\n';

    const scopeGroups = groupBy(group, 'scope');
    for (const scopeName in scopeGroups) {
      markdown += '- `' + scopeName + '`' + '\n';
      for (const commit of scopeGroups[scopeName]) {
        markdown +=
          '  - ' +
          commit.references.join(', ') +
          (commit.references.length ? ' ' : '') +
          commit.message.replace(/^(.)/, v => v.toUpperCase()) +
          '\n';
      }
    }
  }
  const authors = sortBy(uniq(commits.map(commit => commit.authorName).filter(an => !isKnownAuthor(an))));
  if (authors.length) {
    markdown += '\n\n' + '### ' + 'ğŸ’– Thanks to' + '\n\n';
    markdown += authors.map(name => '- ' + name).join('\n');
  }

  return markdown.trim();
}

main().catch(console.error);
```

è¾“å‡ºå¦‚ä¸‹ï¼š
```md
v1 / 2023-xx-xx
===================

### ğŸ› Bug Fixes

- `id`
  - ã€commit message 1ã€‘
- `id2`
  - ã€commit message 1ã€‘
  - ã€commit message 2ã€‘
  - ã€commit message 3ã€‘

### ğŸ’… Refactors

- `id3`
  - commit message 4
  - commit message 5
- `id6`
  - commit message 6


### ğŸ¡ Chore

- `id7`
  - commit message 7

### ğŸ‘“ Tests

- `id8`
  - commit message 8


### ğŸ’– Thanks to

- author1
- author2


```

## ä½¿ç”¨å¼€æºå·¥å…·ç”ŸæˆCHANGELOG.md
> https://github.com/absolute-version/commit-and-tag-version

### åœ¨é¡¹ç›®ä¸­å®‰è£…

```sh
yarn add commit-and-tag-version
```

### ä¿®æ”¹package.json

```json
{
  "scripts": {
    "release": "commit-and-tag-version"
  }
}
```

### ç”ŸæˆCHANGELOG.md

```sh
yarn run release
```
è¾“å‡ºå¦‚ä¸‹ï¼š

```sh
daiyunzhou@daiyunzhoudeMacBook-Pro-2 fe-interview % yarn run release
yarn run v1.22.10
warning ../../../package.json: No license field
$ commit-and-tag-version
âœ” bumping version in package.json from 0.0.1 to 0.0.2
âœ” created CHANGELOG.md
âœ” outputting changes to CHANGELOG.md
âœ” committing package.json and CHANGELOG.md
âœ” tagging release v0.0.2
â„¹ Run `git push --follow-tags origin master && yarn publish` to publish
âœ¨  Done in 2.52s.
```

æŸ¥çœ‹é¡¹ç›®å¦‚ä¸‹ï¼š

![1700fac2df02033abd3d3a9fcf3a76a9](./image/6F39B286-8B0B-4CEE-8126-F72529243317.png)

